# TS-301 — Monthly Dues Generation + Calendar

## Goal

Generate and display **monthly dues** per member/share using the active `RuleSetVersion` and current share allocations, with a calendar-like month selector and clear, auditable totals.

This starts Sprint 3 (“Contributions & Collection”) by making the **monthly collection workflow predictable and reviewable** before payment recording (TS-302).

## Rules Coverage (`rules.md`)

- **Section 6**: contributions/collections, proof and transparency expectations (display totals + per-member due).
- **Section 9.1**: grace/late fee inputs affect later tasks; TS-301 must carry month context cleanly for TS-303.
- **Section 12**: records/transparency; dues generation must be reproducible from stored inputs.
- **Section 17**: operational checklist readiness (monthly checklist will later rely on generated dues).

## Depends On

- TS-101 `RuleSetVersion` snapshot (share value, member count, cycle start)
- TS-202 shares allocations (shares per member)

## Out of Scope

- Recording payments + receipts (TS-302)
- Late fee computation + eligibility gate (TS-303)
- Short pot policies + default enforcement (TS-304/TS-305)

---

## Stage 1 — Figma (UI + Interaction Spec)

### Frames to design

- **Monthly dues overview**
  - Month selector (BillingMonth)
  - Total due amount for the month
  - Per-member rows: shares, due amount, due status (unpaid/paid/partial)
- **Dues month detail**
  - breakdown by member share(s) (if multiple shares)
  - receipt/proof placeholder (future TS-302)
- **Empty / error / loading states**
  - “No shomiti configured”
  - “No members / shares configured”
  - “Generation required” state (if we require explicit generation)

### Interaction notes

- **BillingMonth is a value object** (domain) and must be consistent across UI/domain/data.
- Dues are derived from:
  - share value (BDT) from rules snapshot
  - shares-per-member allocation (TS-202)
  - selected month
- Show copy that is neutral and privacy-safe (no shaming language).
- Display a clear “as of” timestamp for generated months once persistence exists (Stage 3).

### Figma URLs (fill)

- File:
- Nodes:
  - Monthly dues overview:
  - Month detail:

### Commit

- `TS-301 (stage1): figma spec`

### Stage 1 checks

- `flutter analyze`
- `flutter test`

---

## Stage 2 — Flutter UI (1:1 from Figma)

### Deliverables

- Replace `Contributions` placeholder route with a real page.
- Month selector + list of members with computed “due amount” using demo data.
- Stable keys for Patrol tests.

### Commit

- `TS-301 (stage2): flutter ui`

### Stage 2 checks

- `flutter analyze`
- `flutter test`

---

## Stage 3 — Integration (Domain + Data + Persistence)

### Deliverables

- Domain:
  - `BillingMonth` value object
  - `MonthlyDue` entity/model
  - use cases: `GenerateMonthlyDues`, `WatchMonthlyDues` (local-first)
- Data:
  - Drift tables for generated dues + month metadata (idempotent generation)
  - repository implementation + migrations
  - audit events for generation and corrections
- Presentation:
  - controller wired; month list reflects persisted generation

### Commit

- `TS-301 (stage3): domain+data integration`

### Stage 3 checks

- `flutter analyze`
- `flutter test`

---

## Stage 4 — Unit Tests

### Deliverables

- Dues calculation tests for:
  - multiple shares-per-person
  - month boundaries and ordering (BillingMonth compare/next/prev)
  - totals match sum of per-member dues

### Commit

- `TS-301 (stage4): unit tests`

### Stage 4 checks

- `flutter test`

---

## Stage 5 — Patrol UI Tests

### Deliverables

- Patrol:
  - open contributions page
  - switch months
  - verify totals and per-member due rows exist

### Commit

- `TS-301 (stage5): patrol tests`

### Stage 5 checks

- `patrol test`

---

## Stage 6 — E2E Tests

### Deliverables

- E2E: setup demo → shares allocations → generate dues → verify month totals.

### Commit

- `TS-301 (stage6): e2e tests`

### Stage 6 checks

- `patrol test` (E2E suite)

---

## Definition of Done

- All 6 stages complete and committed
- PR checks green
- E2E green
- Merged to `main` (rebase merge) + branch deleted

