# TS-004 — Test Harness Setup (Unit/Widget/Patrol/E2E + CI)

## Goal

Make testing repeatable and CI-ready so every later task can follow the 6-stage pipeline:
- unit/widget test conventions and utilities
- Patrol configured for UI + E2E testing
- baseline smoke tests that run locally on a known device target
- (optional but recommended) GitHub Actions workflow for analyze + tests

## Rules Coverage (`rules.md`)

Cross-cutting: the app’s correctness and auditability depend on reliable testing across all rules.

## Depends On

TS-001 (minimal shell exists for smoke navigation).

## Out of Scope

- Full coverage of all business rules (covered incrementally per feature tasks).
- Remote device farm configuration (can be added post‑MVP).

---

## Stage 1 — Figma (Test Plan / FigJam)

Stage 1 produces a FigJam plan (no heavy UI needed):

### FigJam diagrams
- Test pyramid for this app (domain → data → presentation → integration/e2e)
- E2E scenario map (E2E-00 baseline + registry alignment with `tasks.md`)
- Naming conventions (test ids, semantics, golden tests if used)

### Figma URLs (fill)
- FigJam file:
- Nodes:
  - Test strategy:
  - E2E scenario map:

### Commit
- `TS-004 (stage1): figma spec`

### Stage 1 checks
- `flutter analyze`
- `flutter test`

---

## Stage 2 — Flutter UI (Test Hooks)

### Deliverables
- Add stable **test hooks** (non-visual):
  - semantic labels/keys for primary nav items
  - predictable route names
  - optional “Demo data” debug toggle (guarded, not for release)

### Commit
- `TS-004 (stage2): flutter ui`

---

## Stage 3 — Integration (Patrol + CI)

### Deliverables
- Add dependencies and structure for:
  - `integration_test/` (Flutter integration tests)
  - `patrol` tests (UI + E2E)
- Document how to run:
  - unit tests
  - patrol smoke on iOS simulator / macOS
- Add GitHub Actions workflow to run:
  - `flutter analyze`
  - `flutter test`
  - (optional) integration tests if environment available

### Commit
- `TS-004 (stage3): domain+data integration`

---

## Stage 4 — Unit Tests

### Deliverables
- Test utilities:
  - fake time / BillingMonth helpers (when introduced)
  - Riverpod provider override helpers (when introduced)
- Keep baseline unit tests always passing.

### Commit
- `TS-004 (stage4): unit tests`

---

## Stage 5 — Patrol UI Tests

### Deliverables
- Patrol smoke test:
  - launch app
  - verify shell renders
  - navigate between top-level sections

### Commit
- `TS-004 (stage5): patrol tests`

---

## Stage 6 — E2E Tests

### Deliverables
- E2E-00: launch → shell visible
- Ensure stable execution on at least one configured target (iOS simulator recommended).

### Commit
- `TS-004 (stage6): e2e tests`

