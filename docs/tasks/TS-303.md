# TS-303 — Late Fees + Eligibility Gate

**Goal:** Enforce late-payment policy (grace + per-day fee) and compute draw eligibility per month based on confirmed payment.  
**Rules coverage (rules.md):** §7.2 (eligibility to win requires confirmed payment), §9.1 (late policy: grace + late fee).  
**Depends on:** TS-302 (payments), TS-301 (dues), setup rules snapshot (TS-101).  
**Out of scope:** draw execution (TS-401), payout enforcement (TS-304/TS-403), monthly statement output (TS-501).

## Stage 1 (Figma)

> Figma URLs are pending. If no Figma file is provided, this spec acts as the UI contract for Stage 2.

### Screens / states

1) **Dues list (monthly)**
- For each member row:
  - payment status: `Unpaid` / `Paid`
  - eligibility badge: `Eligible` / `Not eligible`
  - late status:
    - `On time` when within grace window
    - `Late fee: <amount> BDT` when paid after grace window
- Empty/loading/error states unchanged.

2) **Eligibility summary (optional, may be embedded in Dues list)**
- Counts for month:
  - eligible shares/members
  - ineligible shares/members
- Note: “Not eligible to win if unpaid before draw” (neutral copy).

### Deadline parsing policy (needed because deadline is free-text)
Setup stores `paymentDeadline` as a string (e.g., “5th day of the month”). For deterministic policy:
- Extract the **first integer 1–28** from `paymentDeadline` as `deadlineDay`.
- If parsing fails, late/eligibility calculations fall back to:
  - no late fee computation
  - eligibility = paid/unpaid only (no timing).

### Late fee policy (rules snapshot fields)
- `gracePeriodDays` (nullable): when null, treat as 0.
- `lateFeeBdtPerDay` (nullable): when null, treat as 0 (no late fees).
- A payment is “on time” if `confirmedAt <= (deadlineDate + gracePeriodDays)`.
- Late days = whole days after `(deadlineDate + gracePeriodDays)`, min 1.
- Late fee = `lateDays * lateFeeBdtPerDay`.

### Eligibility gate
- Eligible for month draw if:
  - payment is confirmed, and
  - payment confirmed within grace window (same cutoff as late policy).

### Required keys (for tests)
- `dues_eligibility_<position>`
- `dues_late_fee_<position>`
- `eligibility_summary` (if summary card exists)

## Acceptance criteria
- Late fee and eligibility update immediately after recording a payment.
- Audit transparency: late fee computation and eligibility changes are derivable from stored payment confirmation time + rules snapshot.

