# TS-201 — Members CRUD (Identity + Contact + Emergency)

## Goal

Implement member management with strong typing, privacy-safe display, and validation aligned with `rules.md` Sections **3** and **16**.

## Rules Coverage (`rules.md`)

- **Section 3**: Membership rules (eligibility, identity/contact, one person one identity, commitment, joining closed)
- **Section 16**: Privacy & conduct (do not expose personal info without consent; respectful language)

## Depends On

- TS-101 Shomiti Setup Wizard (RuleSetVersion snapshot)
- TS-103 Rules Viewer (for transparency context) *(can be partial if needed)*

## Out of Scope

- Shares allocation (TS-202)
- Guarantor/security deposit (TS-203)
- Exit/replacement/removal governance workflows (TS-204)

---

## Stage 1 — Figma (UI + Interaction Spec)

### Frames to design
- Members list
  - empty state (no members yet)
  - list rows (name + status + role badges optional)
  - search/filter (optional)
- Add member (form)
  - Full name (required)
  - Phone (required)
  - Address/workplace (required or optional — decide and document)
  - NID/passport (optional but supported)
  - Emergency contact (required or recommended)
  - Notes (optional; avoid sensitive content)
- Member detail
  - privacy defaults (mask NID/partial phone)
  - actions: edit, deactivate/remove (governed)
- Edit member (same form as add)
- Dedupe conflict dialog
  - “Potential duplicate” warning when phone/NID matches existing
- Closed-joining guard UI
  - If group is closed and cycle started, show rationale + next steps

### Interaction notes
- Validation:
  - “One person, one identity”: prevent duplicates by phone and NID/passport (with explicit resolution)
  - Required fields as per chosen policy
- Privacy:
  - Hide/mask sensitive fields by default in list/detail
  - Avoid exposing full IDs in screenshots
- Copy:
  - neutral language; no shaming

### Accessibility notes
- Tap targets ≥ 44px
- Form labels and error messages readable
- Keyboard next/done flow

### Figma URLs (fill)
- File:
- Nodes:
  - Members list:
  - Add/Edit form:
  - Member detail:
  - Duplicate dialog:

### Commit
- `TS-201 (stage1): figma spec`

### Stage 1 checks
- `flutter analyze`
- `flutter test`

---

## Stage 2 — Flutter UI (1:1 from Figma)

### Deliverables
- Members list + add/edit/detail screens implemented using design system components.
- Local UI state only (fake repository / demo data).
- Explicit empty/loading/error states.

### Commit
- `TS-201 (stage2): flutter ui`

### Stage 2 checks
- `flutter analyze`
- `flutter test` (widget tests for key states)

---

## Stage 3 — Integration (Domain + Data + Persistence)

### Deliverables
- Domain:
  - `Member` entity (immutable) with typed value objects where needed
  - use cases: `AddMember`, `UpdateMember`, `DeactivateMember`, `ListMembers`
  - dedupe checks for phone and optional NID/passport
- Data:
  - Drift tables + repository implementation
  - migrations and repository tests
- Presentation:
  - Riverpod controllers wired to use cases
  - audit events written for create/update/deactivate

### Commit
- `TS-201 (stage3): domain+data integration`

### Stage 3 checks
- `flutter analyze`
- `flutter test`

---

## Stage 4 — Unit Tests

### Deliverables
- Use case tests: required fields, dedupe rules, closed-joining constraints
- Repository tests: create/update/deactivate flows

### Commit
- `TS-201 (stage4): unit tests`

### Stage 4 checks
- `flutter test`

---

## Stage 5 — Patrol UI Tests

### Deliverables
- Patrol flow:
  - add member → verify in list
  - edit member → verify update
  - deactivate member → verify status

### Commit
- `TS-201 (stage5): patrol tests`

### Stage 5 checks
- `patrol test`

---

## Stage 6 — E2E Tests

### Deliverables
- E2E:
  - setup wizard → add 3 members → verify list
  - verify privacy defaults (masking) on detail view

### Commit
- `TS-201 (stage6): e2e tests`

### Stage 6 checks
- `patrol test` (E2E suite)

---

## Definition of Done

- All 6 stages complete and committed
- PR checks green
- E2E green
- Merged to `main` (rebase merge) + branch deleted

