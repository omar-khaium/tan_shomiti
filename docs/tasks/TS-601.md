# TS-601 — Exports (PDF/CSV) + Redaction + Consent Gates

## Goal
Add **export/share** capabilities for key records (ledger + statements) while staying **100% compliant** with:
- `rules.md` **Section 12** (records / statements)
- `rules.md` **Section 16** (privacy & conduct)

Exports must be **safe-by-default**, with clear user intent and optional redaction.

## Non-goals (this task)
- Cloud sync / multi-device sharing
- External integrations (Google Drive/WhatsApp APIs)
- Custom report builder (future)

## UX / Screens (MVP)

### 1) Exports hub (new)
Entry: `More` → `Exports`.

Sections:
- **Statements**: export/share a monthly statement (PDF + CSV if applicable)
- **Ledger**: export/share a filtered ledger view (CSV first; PDF optional)

States:
- loading / empty / error
- “privacy notice” card (always visible)

### 2) Export options (new)
For a chosen source (statement or ledger):
- format selector: `PDF` / `CSV` (MVP: allow either; implement at least CSV first if PDF is deferred)
- redaction toggles (defaults ON):
  - hide phone/address/emergency contacts
  - hide NID/passport
  - hide free-text notes (member notes / dispute notes)
- scope selector:
  - statement: month required
  - ledger: date range / month (start simple)

CTA:
- `Generate`
- `Share` (uses platform share sheet once generated)

### 3) Consent gate (new, if needed)
If export includes any member identifiers beyond display name (or includes any sensitive fields), require:
- explicit confirmation checkbox: “I have consent to share this outside the group”
- optional: record a **consent reference** (chat msg id) (recommended)

## Compliance requirements (acceptance)
- Privacy first:
  - Default export must not include sensitive member PII fields (Section 16).
  - Export content must avoid “shaming” language; neutral labels only.
- Auditability:
  - Every export/share action records an audit event:
    - `export_generated`
    - `export_shared` (if share invoked)
  - Audit metadata contains **only non-sensitive** identifiers (no PII).
- Deterministic outputs:
  - CSV column order is stable and documented.
  - Export generation is idempotent for the same inputs (same content).

## Architecture notes
- Clean Architecture:
  - `exports/domain`: policies (redaction), value objects (ExportRequest), use-cases (GenerateExport, ShareExport, RecordExportAudit)
  - `exports/data`: generators (csv/pdf), temp file handling, caching
  - `exports/presentation`: Riverpod controllers + UI

## Figma
- Figma file/page/node: **TBD** (Stage 1 placeholder)
- (Optional) FigJam: export flow + consent gate decision tree

## Stage-specific testing expectations

### Stage 2 (UI)
- Widget tests for Exports hub empty/loading/error.
- Export options screen renders toggles and disables Share until generated.

### Stage 3 (logic)
- Unit tests for redaction policy (defaults ON).
- Audit events emitted on generate/share.

### Stage 5 (Patrol)
- Generate CSV for a statement and ensure file is produced (path exists).

### Stage 6 (E2E)
- Full flow: generate export → share trigger (mocked/no-op if platform blocks) → audit event visible in Audit Log.

