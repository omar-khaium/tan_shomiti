# TS-503 — Rule Amendments + Unanimous Consent

## Goal
Support **rule changes** (`rules.md` Section 15) in a way that is:
- fully auditable (“written record”, dated, and reference to where it was shared)
- **non-retroactive** (past records keep their original `RuleSetVersion`)
- compliant with the rule snapshot model (`RuleSetSnapshot` / `RuleSetVersion`)

This task adds the ability to **propose**, **collect consent**, and **apply** a new `RuleSetVersion`.

## Rules coverage
`rules.md`:
- **15) Rule Changes**
  - Before start: configurable majority/unanimous (from setup snapshot)
  - After start (default): changes require **unanimous consent**
  - Written record: must be written, dated, shared in group channel (store proof reference)

## Non-goals (this task)
- PDF/CSV exports of rules/history (TS-601)
- Disputes workflow (TS-504)
- Multi-shomiti management (out of scope)

## UX / Screens

### 1) “Rule changes” (new)
Accessible from `More` → `Rule changes`.

Shows:
- Current active ruleset summary:
  - active `RuleSetVersion` id + createdAt
  - key fields (share value, cycle length, deadlines, policies)
- Change history (chronological list):
  - status: `Draft`, `Pending consent`, `Applied`, `Rejected` (if supported)
  - createdAt
  - “what changed” summary
  - written record reference (required at apply-time)
- Pending change (if any):
  - consent progress: signed/required count
  - CTA: `Collect consent`
  - CTA: `Apply change` (enabled only when required consent reached)

### 2) Propose change (new)
A guided flow that clones the **current active** `RuleSetSnapshot` and lets the user edit:
- amounts: `shareValueBdt`, fees settings (if enabled)
- schedule: cycle length, meeting schedule, payment deadline
- policies: missed payment policy, grace period, default thresholds
- governance-related toggles already in snapshot (e.g., share transfer policy)

Requires:
- a short “Amendment note” (written record summary)
- (optional at propose time) a “Shared in group channel” reference (can be required at apply-time)

### 3) Consent collection (new)
Collect member consent for the **proposed** `RuleSetVersion`:
- list active members with consent status
- record consent:
  - proof type: `signature` / `otp` / `chatReference`
  - proof reference (required)
- show “required consent rule” (before/after start)

## Domain rules (acceptance)

### Consent thresholds
- Determine whether the shomiti has “started” using `RuleSetSnapshot.startDate` vs `now`.
- If **after start** and `ruleChangeAfterStartRequiresUnanimous == true`:
  - applying a change requires **unanimous consent** of all **active** members.
- If **before start**:
  - applying a change requires **majority or unanimous** based on the rule snapshot configuration
  - (MVP: if the app only supports unanimous, explicitly document and enforce it.)

### Immutability + safety
- The currently active `RuleSetVersion` is never edited.
- An amendment creates a **new** `RuleSetVersion`.
- Once applied, the amendment becomes read-only.
- Past records (dues, payments, draws, statements) keep their own `ruleSetVersionId`.

### Written record requirement
- Applying an amendment requires:
  - a non-empty amendment note, and
  - a non-empty “shared reference” (e.g. link/message id in group channel),
  - plus `appliedAt` timestamp.

### Audit trail
Append audit events (no PII in metadata):
- `rule_change_proposed`
- `rule_change_consent_recorded`
- `rule_change_applied`

## Data requirements
- Persist amendments and their metadata:
  - `baseRuleSetVersionId`
  - `proposedRuleSetVersionId`
  - amendment note + shared reference
  - status + timestamps (`createdAt`, `appliedAt`)
- Consent records should reuse existing `MemberConsent` storage keyed by `ruleSetVersionId`.

## Architecture notes
- Clean Architecture boundaries:
  - `rules/domain`: policy + use-cases (propose/apply)
  - `rules/data`: drift repositories + migrations
  - `rules/presentation`: Riverpod providers/controllers + UI pages
- Prefer Riverpod for DI/state (consistent with existing codebase).

## Figma
- Figma file/page/node: **TBD** (Stage 1 placeholder)
- (Optional) FigJam: flow diagram for propose → consent → apply.

## Stage-specific testing expectations

### Stage 2 (UI)
- Widget tests for:
  - empty history
  - pending amendment card
  - apply button disabled/enabled states

### Stage 3 (logic)
- Unit tests for:
  - after-start unanimous enforcement
  - before-start threshold rule (majority/unanimous)
  - required written record fields at apply-time

### Stage 5 (Patrol)
- Propose amendment → collect consent → apply → verify rules viewer shows new active version.

### Stage 6 (E2E)
- Full flow persists across reopen:
  - propose → consent → apply → restart/open → active ruleset updated + history retained.

