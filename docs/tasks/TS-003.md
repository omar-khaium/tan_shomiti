# TS-003 — Data & Audit Foundation

## Goal

Implement the local-first persistence and audit primitives required for transparency and long-term maintainability:
- typed local database
- repository interfaces + implementations skeleton
- append-only ledger foundation
- audit event logging foundation

## Rules Coverage (`rules.md`)

- Section 2 (Trust + transparency; safety)
- Section 4 (two-person verification support)
- Section 12 (Ledger + records + audit)
- Section 16 (Privacy)
- Section 17 (Monthly operational checklist requires verifiable records)

## Depends On

TS-001 (app shell exists to host future admin screens).

## Out of Scope

- Full business workflows (payments, draw, payout) — later sprints.
- Remote sync — post‑MVP.

---

## Stage 1 — Figma (FigJam / Admin Screens Spec)

Since this is backend-heavy, Stage 1 produces:

### FigJam diagrams
- Data flow diagram (UI → controllers → use cases → repos → DB)
- Ledger model overview (append-only entries → derived monthly statement)
- Audit model overview (who/what/when/proof)

### Optional admin UI frames
- Audit Log Viewer (read-only list)
- Ledger Viewer (read-only list)

### Figma URLs (fill)
- FigJam file:
- Nodes:
  - Data flow:
  - Ledger overview:
  - Audit overview:
  - (Optional) Audit viewer:
  - (Optional) Ledger viewer:

### Commit
- `TS-003 (stage1): figma spec`

### Stage 1 checks
- `flutter analyze`
- `flutter test`

---

## Stage 2 — Flutter UI (Viewer Screens)

### Deliverables
- Minimal read-only screens wired into shell navigation:
  - Audit log viewer (empty state if no events)
  - Ledger viewer (empty state if no entries)
- No real data yet (can use a stub repository until Stage 3).

### Commit
- `TS-003 (stage2): flutter ui`

---

## Stage 3 — Integration (DB + Repositories)

### Deliverables
- Choose a local DB:
  - Recommended: Drift (SQLite) for strong typing and query support.
- Implement:
  - `AppDatabase` with tables:
    - `audit_events`
    - `ledger_entries`
    - `rule_set_versions` (placeholder structure)
  - Repository skeletons with clean boundaries:
    - `AuditRepository`
    - `LedgerRepository`
    - `RulesRepository` (placeholder)
- Enforce append-only invariant for ledger entries at repository layer.
- Store only necessary PII and prepare redaction helpers for exports.

### Commit
- `TS-003 (stage3): domain+data integration`

---

## Stage 4 — Unit Tests

### Deliverables
- Data tests:
  - ledger append-only behavior
  - audit event insert/query
  - migration baseline (if migrations exist)

### Commit
- `TS-003 (stage4): unit tests`

---

## Stage 5 — Patrol UI Tests

### Deliverables
- Patrol: open ledger/audit viewers and verify empty state renders.

### Commit
- `TS-003 (stage5): patrol tests`

---

## Stage 6 — E2E Tests

### Deliverables
- Extend E2E smoke:
  - launch app
  - open ledger/audit viewer
  - (optional) create a demo audit event in debug mode and verify it appears

### Commit
- `TS-003 (stage6): e2e tests`

