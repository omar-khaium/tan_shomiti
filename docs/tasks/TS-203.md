# TS-203 — Guarantor / Security Deposit

## Goal

Capture and manage pre-cycle risk controls required by `rules.md` Section **9.3** (guarantor or security deposit) with proof records.

## Rules Coverage (`rules.md`)

- **Section 9.3**: Default after winning (highest risk) → require guarantor or refundable deposit (recommended)

## Depends On

- TS-201 Members CRUD (member list exists)
- TS-101 RuleSetVersion snapshot (policy context)

## Out of Scope

- Enforcement workflow (reminders, notices, guarantor contact escalation) → later tasks
- Money collection and payouts

---

## Stage 1 — Figma (UI + Interaction Spec)

### Frames to design
- Risk controls overview
  - per-member status: missing / guarantor recorded / deposit recorded
  - warnings for missing controls
- Add guarantor (per member)
  - guarantor name + phone + relationship (optional)
  - acceptance timestamp + proof reference
- Add security deposit (per member)
  - amount (BDT)
  - held by (text / role)
  - proof reference (receipt/screenshot ref)
  - status: held / returned
- Member detail section (shows guarantor/deposit)

### Interaction notes
- Require at least one: guarantor OR deposit, as configured by group policy (if optional, default recommended).
- Proof fields should avoid sensitive content.

### Accessibility notes
- Forms accessible, clear error messages

### Figma URLs (fill)
- File:
- Nodes:
  - Overview:
  - Guarantor form:
  - Deposit form:

### Commit
- `TS-203 (stage1): figma spec`

### Stage 1 checks
- `flutter analyze`
- `flutter test`

---

## Stage 2 — Flutter UI (1:1 from Figma)

### Deliverables
- Risk controls screens with demo data.
- Stable keys for Patrol tests.

### Commit
- `TS-203 (stage2): flutter ui`

### Stage 2 checks
- `flutter analyze`
- `flutter test`

---

## Stage 3 — Integration (Domain + Data + Persistence)

### Deliverables
- Domain:
  - `Guarantor` and `SecurityDeposit` models
  - use cases: `RecordGuarantor`, `RecordSecurityDeposit`, `MarkDepositReturned`
  - readiness checks for “risk control complete” per member
- Data:
  - Drift tables + repositories
  - audit events for create/update/return
- Presentation:
  - controllers wired; per-member status visible

### Commit
- `TS-203 (stage3): domain+data integration`

### Stage 3 checks
- `flutter analyze`
- `flutter test`

---

## Stage 4 — Unit Tests

### Deliverables
- Use case tests:
  - cannot record invalid amounts
  - per-member “must have guarantor OR deposit” rule (when enabled)

### Commit
- `TS-203 (stage4): unit tests`

### Stage 4 checks
- `flutter test`

---

## Stage 5 — Patrol UI Tests

### Deliverables
- Patrol:
  - record guarantor for a member
  - record deposit for another member
  - status updates visible

### Commit
- `TS-203 (stage5): patrol tests`

### Stage 5 checks
- `patrol test`

---

## Stage 6 — E2E Tests

### Deliverables
- E2E: setup → add members → record risk controls → verify readiness.

### Commit
- `TS-203 (stage6): e2e tests`

### Stage 6 checks
- `patrol test` (E2E suite)

---

## Definition of Done

- All 6 stages complete and committed
- PR checks green
- E2E green
- Merged to `main` (rebase merge) + branch deleted

