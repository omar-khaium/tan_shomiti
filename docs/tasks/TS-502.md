# TS-502 — Monthly Statement Sign-Off (Auditor/Witness)

## Goal
Add **sign-off** for a generated monthly statement so the group can document that the statement was reviewed and approved, aligned with `rules.md`:
- Section 4 (roles + oversight)
- Section 12 (records + audit sign-off)

This task builds on TS-501 “Monthly statement generation”.

## Non-goals (this task)
- PDF/CSV export (TS-601)
- Rule amendment/versioning changes (TS-503)

## UX / Screens

### 1) Statement detail (existing)
Add a **Sign-off** section to the statement detail screen:
- Status:
  - `Not signed`
  - `Partially signed`
  - `Signed`
- Summary:
  - signer(s) list (name + role + signedAt)
  - proof reference per signer
- Actions:
  - `Add sign-off`
  - `View sign-offs` (if any)

### 2) Add sign-off flow (new)
A modal/page to add a sign-off entry:
- Select signer member (from member list)
- Select signer role context:
  - `Auditor`
  - `Witness`
- Proof reference (required; e.g., transaction proof / chat link / signature id)
- Notes (optional)
- Confirm

### 3) Business states
- Loading / empty / error states for sign-offs.
- If statement not generated yet:
  - sign-off actions are hidden/disabled (statement must exist first).
- Validation errors are clear and non-judgmental.

## Domain rules (acceptance)

### Sign-off requirements
- A statement can be considered “Signed” if **either**:
  1) at least **1 Auditor** sign-off exists, **or**
  2) at least **2 Witness** sign-offs exist (distinct members).
- Duplicate sign-offs by the same member for the same statement month are prevented (idempotent update).

### Audit trail
Record audit events (no PII in metadata):
- `statement_signed` when a sign-off is added
- `statement_signoff_removed` if a removal is supported (optional for this task)

## Data requirements
- Persist sign-offs per `shomitiId + month`.
- Sign-off model is immutable and versionable (append-only list or last-write-wins with history table; choose during Stage 3).

## Architecture notes
- Clean Architecture boundaries:
  - `domain/` defines entities + repository interface + use cases
  - `data/` implements persistence (Drift)
  - `presentation/` uses Riverpod controllers/providers

## Figma
- Figma file/page/node: **TBD** (Stage 1 placeholder)
- Components reuse: existing `AppCard`, `AppButton`, status chips.

## Stage-specific testing expectations

### Stage 2 (UI)
- Widget tests for statement detail sign-off section states:
  - no statement
  - statement + no sign-offs
  - statement + signed

### Stage 3 (logic)
- Unit tests for “Signed” calculation rules.
- Repository tests for persistence (if added).

### Stage 5 (Patrol)
- Generate statement → add sign-off(s) → verify status changes.

### Stage 6 (E2E)
- Full flow: payout → statement → sign-off → reopen statement → sign-off persists.

